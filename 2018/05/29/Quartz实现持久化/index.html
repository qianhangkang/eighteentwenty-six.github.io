<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="最近项目中出现需求为：给定参数和时间，定时发送短信。同时希望如果服务器挂了能够重新运行这个定时任务。 准备使用quartz做。 所有代码在GitHub上，帮助到你就点个赞呗~ quartz的任务存储（Job Stores）模式有三种：RAMJobStore、JDBCJobStore、TerracottaJobStore">
<meta name="keywords" content="Quartz">
<meta property="og:type" content="article">
<meta property="og:title" content="Quartz实现持久化">
<meta property="og:url" content="https:&#x2F;&#x2F;cnhkblog.top&#x2F;2018&#x2F;05&#x2F;29&#x2F;Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96&#x2F;index.html">
<meta property="og:site_name" content="萍水相逢 互道安好">
<meta property="og:description" content="最近项目中出现需求为：给定参数和时间，定时发送短信。同时希望如果服务器挂了能够重新运行这个定时任务。 准备使用quartz做。 所有代码在GitHub上，帮助到你就点个赞呗~ quartz的任务存储（Job Stores）模式有三种：RAMJobStore、JDBCJobStore、TerracottaJobStore">
<meta property="og:locale" content="en">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;30&#x2F;5b0e0f8db01b3.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;30&#x2F;5b0e0f8dbff34.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;30&#x2F;5b0e0f8db9358.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;30&#x2F;5b0e0f8dba9c3.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;30&#x2F;5b0e0f8dc1956.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;30&#x2F;5b0e0f8dc2fff.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;31&#x2F;5b0fb1ca774b7.png">
<meta property="og:updated_time" content="2019-11-02T06:27:51.862Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2018&#x2F;05&#x2F;30&#x2F;5b0e0f8db01b3.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Quartz实现持久化</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/06/02/%E8%BD%AC%E8%BD%BD%EF%BC%9A%E4%B8%80%E5%8F%A5%E2%80%98%E5%9C%A8%E5%90%97%E2%80%99%E9%80%BC%E6%AD%BB%E4%BA%BA/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/04/29/ElasticSearch%E8%80%81%E7%89%88%E6%9C%AC%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&text=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&is_video=false&description=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Quartz实现持久化&body=Check out this article: https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&name=Quartz实现持久化&description=&lt;p&gt;最近项目中出现需求为：给定参数和时间，定时发送短信。同时希望如果服务器挂了能够重新运行这个定时任务。&lt;/p&gt;
&lt;p&gt;准备使用quartz做。&lt;/p&gt;
&lt;p&gt;所有代码在&lt;a href=&#34;https://github.com/qianhangkang/justdoit/tree/master/quartz&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;GitHub&lt;/a&gt;上，帮助到你就点个赞呗~&lt;/p&gt;
&lt;p&gt;quartz的任务存储（Job Stores）模式有三种：RAMJobStore、JDBCJobStore、TerracottaJobStore&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#三种任务存储模式"><span class="toc-number">1.</span> <span class="toc-text">三种任务存储模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RAMJobStore"><span class="toc-number">1.1.</span> <span class="toc-text">RAMJobStore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JDBCJobStore"><span class="toc-number">1.2.</span> <span class="toc-text">JDBCJobStore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TerracottaJobStore"><span class="toc-number">1.3.</span> <span class="toc-text">TerracottaJobStore</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#原生持久化解决方案"><span class="toc-number">2.</span> <span class="toc-text">原生持久化解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#quartz持久化需要的表SQL"><span class="toc-number">2.1.</span> <span class="toc-text">quartz持久化需要的表SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pom文件"><span class="toc-number">2.2.</span> <span class="toc-text">pom文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java代码设置quartz配置"><span class="toc-number">2.3.</span> <span class="toc-text">Java代码设置quartz配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现Job接口"><span class="toc-number">2.4.</span> <span class="toc-text">实现Job接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现JobListener接口"><span class="toc-number">2.5.</span> <span class="toc-text">实现JobListener接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#向schedule添加自定义MyJob"><span class="toc-number">2.6.</span> <span class="toc-text">向schedule添加自定义MyJob</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller层"><span class="toc-number">2.7.</span> <span class="toc-text">controller层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结果演示"><span class="toc-number">2.8.</span> <span class="toc-text">结果演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过接口添加一个job"><span class="toc-number">2.8.1.</span> <span class="toc-text">通过接口添加一个job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看数据库"><span class="toc-number">2.8.2.</span> <span class="toc-text">查看数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过接口查看待执行的任务"><span class="toc-number">2.8.3.</span> <span class="toc-text">通过接口查看待执行的任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一分钟后任务执行"><span class="toc-number">2.8.4.</span> <span class="toc-text">一分钟后任务执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#监听器存在的一个问题"><span class="toc-number">2.9.</span> <span class="toc-text">监听器存在的一个问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#自定义解决方案"><span class="toc-number">3.</span> <span class="toc-text">自定义解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#我的自定义的quartz持久化表"><span class="toc-number">3.1.</span> <span class="toc-text">我的自定义的quartz持久化表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pom文件-1"><span class="toc-number">3.2.</span> <span class="toc-text">pom文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java代码设置quartz配置-1"><span class="toc-number">3.3.</span> <span class="toc-text">Java代码设置quartz配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现job接口"><span class="toc-number">3.4.</span> <span class="toc-text">实现job接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现JobListener接口-1"><span class="toc-number">3.5.</span> <span class="toc-text">实现JobListener接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加job"><span class="toc-number">3.6.</span> <span class="toc-text">添加job</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller层-1"><span class="toc-number">3.7.</span> <span class="toc-text">controller层</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#两种方案比较"><span class="toc-number">4.</span> <span class="toc-text">两种方案比较</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#quartz原生持久化"><span class="toc-number">4.1.</span> <span class="toc-text">quartz原生持久化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Quartz实现持久化
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">萍水相逢 互道安好</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-05-29T11:26:22.000Z" itemprop="datePublished">2018-05-29</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Quartz/" rel="tag">Quartz</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>最近项目中出现需求为：给定参数和时间，定时发送短信。同时希望如果服务器挂了能够重新运行这个定时任务。</p>
<p>准备使用quartz做。</p>
<p>所有代码在<a href="https://github.com/qianhangkang/justdoit/tree/master/quartz" target="_blank" rel="noopener">GitHub</a>上，帮助到你就点个赞呗~</p>
<p>quartz的任务存储（Job Stores）模式有三种：RAMJobStore、JDBCJobStore、TerracottaJobStore</p>
<a id="more"></a>



<h1 id="三种任务存储模式"><a href="#三种任务存储模式" class="headerlink" title="三种任务存储模式"></a>三种任务存储模式</h1><h2 id="RAMJobStore"><a href="#RAMJobStore" class="headerlink" title="RAMJobStore"></a>RAMJobStore</h2><p>最简单的、性能最高的、也是<strong>默认</strong>的一种jobstore，所有数据存放在内存中，如果程序重启或关闭，所有的job都会丢失。</p>
<h2 id="JDBCJobStore"><a href="#JDBCJobStore" class="headerlink" title="JDBCJobStore"></a>JDBCJobStore</h2><p>性能比RAMJobStore差，所有数据存放在数据库中， JDBCJobStore几乎适用于任何数据库。要使用JDBCJobStore，您必须首先为Quartz创建一组数据库表以供使用。当然，你<strong>不需要</strong>实现任何一条SQL语句。</p>
<p>在配置和启动JDBCJobStore之前，您需要确定应用程序需要什么类型的事务。</p>
<ul>
<li>如果您不需要将调度命令（例如添加和删除触发器）与其他事务绑定在一起，那么您可以让Quartz使用<strong>JobStoreTX</strong>作为JobStore（这是最常见的选择）来管理事务。</li>
<li>如果您需要Quartz与其他事务一起工作（即在J2EE应用程序服务器中），那么您应该使用<strong>JobStoreCMT–</strong>在这种情况下，Quartz将让应用程序服务器容器管理事务。</li>
</ul>
<h2 id="TerracottaJobStore"><a href="#TerracottaJobStore" class="headerlink" title="TerracottaJobStore"></a>TerracottaJobStore</h2><p>TerracottaJobStore是Quartz 1.7的新成员。它提供了一种扩展和健壮性的方法，而不需要使用数据库。这意味着您的数据库可以从Quartz中免费加载，并且可以将其所有资源保存到其他应用程序中。</p>
<h1 id="原生持久化解决方案"><a href="#原生持久化解决方案" class="headerlink" title="原生持久化解决方案"></a>原生持久化解决方案</h1><blockquote>
<p>IDE：idea</p>
<p>jdk：1.8</p>
<p>框架：springboot (v2.0.2.RELEASE)、quartz(v2.3.0)、lombok</p>
</blockquote>
<h2 id="quartz持久化需要的表SQL"><a href="#quartz持久化需要的表SQL" class="headerlink" title="quartz持久化需要的表SQL"></a>quartz持久化需要的表SQL</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># In your Quartz properties file, you will need to set   </span></span><br><span class="line"><span class="comment"># org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># By: Ron Cordell - roncordell</span></span><br><span class="line"><span class="comment"># I didn't see this anywhere, so I thought I'd post it here. </span></span><br><span class="line"><span class="comment"># This is the script from Quartz to create the tables in a MySQL database,</span></span><br><span class="line"><span class="comment"># modified to use INNODB instead of MYISAM. </span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_FIRED_TRIGGERS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_PAUSED_TRIGGER_GRPS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_SCHEDULER_STATE;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_LOCKS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_SIMPLE_TRIGGERS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_SIMPROP_TRIGGERS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_CRON_TRIGGERS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_BLOB_TRIGGERS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_TRIGGERS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_JOB_DETAILS;  </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_CALENDARS;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_JOB_DETAILS(  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">JOB_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">JOB_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">DESCRIPTION <span class="built_in">VARCHAR</span>(<span class="number">250</span>) <span class="literal">NULL</span>,  </span><br><span class="line">JOB_CLASS_NAME <span class="built_in">VARCHAR</span>(<span class="number">250</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">IS_DURABLE <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">IS_NONCONCURRENT <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">IS_UPDATE_DATA <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">REQUESTS_RECOVERY <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">JOB_DATA <span class="built_in">BLOB</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,JOB_NAME,JOB_GROUP))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_TRIGGERS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">JOB_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">JOB_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">DESCRIPTION <span class="built_in">VARCHAR</span>(<span class="number">250</span>) <span class="literal">NULL</span>,  </span><br><span class="line">NEXT_FIRE_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="literal">NULL</span>,  </span><br><span class="line">PREV_FIRE_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="literal">NULL</span>,  </span><br><span class="line"><span class="keyword">PRIORITY</span> <span class="built_in">INTEGER</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_STATE <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_TYPE <span class="built_in">VARCHAR</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">START_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">END_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="literal">NULL</span>,  </span><br><span class="line">CALENDAR_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="literal">NULL</span>,  </span><br><span class="line">MISFIRE_INSTR <span class="built_in">SMALLINT</span>(<span class="number">2</span>) <span class="literal">NULL</span>,  </span><br><span class="line">JOB_DATA <span class="built_in">BLOB</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),  </span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,JOB_NAME,JOB_GROUP)  </span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_SIMPLE_TRIGGERS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">REPEAT_COUNT <span class="built_in">BIGINT</span>(<span class="number">7</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">REPEAT_INTERVAL <span class="built_in">BIGINT</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TIMES_TRIGGERED <span class="built_in">BIGINT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),  </span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)  </span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_CRON_TRIGGERS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">CRON_EXPRESSION <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TIME_ZONE_ID <span class="built_in">VARCHAR</span>(<span class="number">80</span>),  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),  </span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)  </span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_SIMPROP_TRIGGERS  </span><br><span class="line">  (            </span><br><span class="line">    SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    STR_PROP_1 <span class="built_in">VARCHAR</span>(<span class="number">512</span>) <span class="literal">NULL</span>,  </span><br><span class="line">    STR_PROP_2 <span class="built_in">VARCHAR</span>(<span class="number">512</span>) <span class="literal">NULL</span>,  </span><br><span class="line">    STR_PROP_3 <span class="built_in">VARCHAR</span>(<span class="number">512</span>) <span class="literal">NULL</span>,  </span><br><span class="line">    INT_PROP_1 <span class="built_in">INT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    INT_PROP_2 <span class="built_in">INT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    LONG_PROP_1 <span class="built_in">BIGINT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    LONG_PROP_2 <span class="built_in">BIGINT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    DEC_PROP_1 <span class="built_in">NUMERIC</span>(<span class="number">13</span>,<span class="number">4</span>) <span class="literal">NULL</span>,  </span><br><span class="line">    DEC_PROP_2 <span class="built_in">NUMERIC</span>(<span class="number">13</span>,<span class="number">4</span>) <span class="literal">NULL</span>,  </span><br><span class="line">    BOOL_PROP_1 <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,  </span><br><span class="line">    BOOL_PROP_2 <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,  </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),  </span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)   </span><br><span class="line">    <span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_BLOB_TRIGGERS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">BLOB_DATA <span class="built_in">BLOB</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),  </span><br><span class="line"><span class="keyword">INDEX</span> (SCHED_NAME,TRIGGER_NAME, TRIGGER_GROUP),  </span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)  </span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_CALENDARS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">CALENDAR_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">CALENDAR <span class="built_in">BLOB</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,CALENDAR_NAME))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_PAUSED_TRIGGER_GRPS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_GROUP))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_FIRED_TRIGGERS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">ENTRY_ID <span class="built_in">VARCHAR</span>(<span class="number">95</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">INSTANCE_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">FIRED_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">SCHED_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line"><span class="keyword">PRIORITY</span> <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">STATE <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">JOB_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="literal">NULL</span>,  </span><br><span class="line">JOB_GROUP <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="literal">NULL</span>,  </span><br><span class="line">IS_NONCONCURRENT <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,  </span><br><span class="line">REQUESTS_RECOVERY <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,ENTRY_ID))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_SCHEDULER_STATE (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">INSTANCE_NAME <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">LAST_CHECKIN_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">CHECKIN_INTERVAL <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,INSTANCE_NAME))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_LOCKS (  </span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">LOCK_NAME <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,LOCK_NAME))  </span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_J_REQ_RECOVERY <span class="keyword">ON</span> QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_J_GRP <span class="keyword">ON</span> QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_J <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_JG <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_C <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_G <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_STATE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_N_STATE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_N_G_STATE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NEXT_FIRE_TIME <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_ST <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_MISFIRE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE_GRP <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_TRIG_INST_NAME <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_INST_JOB_REQ_RCVRY <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_J_G <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_JG <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_T_G <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_TG <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>



<h2 id="pom文件"><a href="#pom文件" class="headerlink" title="pom文件"></a>pom文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.hongkong&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;demo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;demo&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.2.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--quartz--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--mysql--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--lombok--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--mybatis，提供DataSource，也可以使用springboot的jdbc，如下--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.3.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--&amp;lt;!&amp;ndash;springboot的jdbc&amp;ndash;&amp;gt;--&gt;</span><br><span class="line">        &lt;!--&lt;dependency&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;/dependency&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;dependency&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;groupId&gt;com.h2database&lt;/groupId&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;artifactId&gt;h2&lt;/artifactId&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;/dependency&gt;--&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>



<h2 id="Java代码设置quartz配置"><a href="#Java代码设置quartz配置" class="headerlink" title="Java代码设置quartz配置"></a>Java代码设置quartz配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * quartz的Java配置文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QuartzListener listener;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SchedulerFactoryBean <span class="title">schedulerFactoryBean</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        SchedulerFactoryBean schedulerFactoryBean = <span class="keyword">new</span> SchedulerFactoryBean();</span><br><span class="line">        schedulerFactoryBean.setSchedulerName(<span class="string">"MsmJobSchedule"</span>);</span><br><span class="line">        <span class="comment">//设置数据库数据源</span></span><br><span class="line">        schedulerFactoryBean.setDataSource(dataSource);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//quartz参数</span></span><br><span class="line">        Properties prop = <span class="keyword">new</span> Properties();</span><br><span class="line">        prop.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, <span class="string">"MsmJobSchedule"</span>);</span><br><span class="line">        prop.put(<span class="string">"org.quartz.scheduler.instanceId"</span>, <span class="string">"AUTO"</span>);</span><br><span class="line">        <span class="comment">//线程池配置</span></span><br><span class="line">        prop.put(<span class="string">"org.quartz.threadPool.class"</span>, <span class="string">"org.quartz.simpl.SimpleThreadPool"</span>);</span><br><span class="line">        <span class="comment">//并行的线程数，默认为10</span></span><br><span class="line">        prop.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"10"</span>);</span><br><span class="line">        <span class="comment">//线程优先级，默认为5</span></span><br><span class="line">        prop.put(<span class="string">"org.quartz.threadPool.threadPriority"</span>, <span class="string">"5"</span>);</span><br><span class="line">        <span class="comment">//JobStore配置</span></span><br><span class="line">        prop.put(<span class="string">"org.quartz.jobStore.class"</span>, <span class="string">"org.quartz.impl.jdbcjobstore.JobStoreTX"</span>);</span><br><span class="line">        <span class="comment">//配置是否启动自动加载数据库内的定时任务，默认true</span></span><br><span class="line">        prop.put(<span class="string">"org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread"</span>,<span class="string">"true"</span>);</span><br><span class="line">        <span class="comment">//持久化方式配置数据驱动，MySQL数据库</span></span><br><span class="line">        prop.put(<span class="string">"org.quartz.jobStore.driverDelegateClass"</span>,<span class="string">"org.quartz.impl.jdbcjobstore.StdJDBCDelegate"</span>);</span><br><span class="line">        <span class="comment">//设置property</span></span><br><span class="line">        schedulerFactoryBean.setQuartzProperties(prop);</span><br><span class="line">        <span class="comment">//延时启动10s</span></span><br><span class="line">        schedulerFactoryBean.setStartupDelay(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> schedulerFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">scheduler</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        Scheduler scheduler = schedulerFactoryBean(dataSource).getScheduler();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//每次schedule初始化时添加监听器，否则程序重启后之前的任务无法被监听</span></span><br><span class="line">            log.info(<span class="string">"添加监听器至schedule"</span>);</span><br><span class="line">            scheduler.getListenerManager().addJobListener(listener);<span class="comment">//listener自动注入</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            log.debug(<span class="string">"监听器添加至schedule失败"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现Job接口"><a href="#实现Job接口" class="headerlink" title="实现Job接口"></a>实现Job接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Job执行的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context job上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> JobExecutionException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"任务&#123;&#125;开始执行任务"</span>,context.getFireInstanceId());</span><br><span class="line">        <span class="comment">//得到传入job的参数</span></span><br><span class="line">        JobDataMap dataMap = context.getJobDetail().getJobDataMap();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"任务&#123;&#125;执行结束"</span>,context.getFireInstanceId());</span><br><span class="line">        context.setResult(String.format(<span class="string">"%s say 'hello' to listener"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现JobListener接口"><a href="#实现JobListener接口" class="headerlink" title="实现JobListener接口"></a>实现JobListener接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzListener</span> <span class="keyword">implements</span> <span class="title">JobListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"QuartzListener"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jobToBeExecuted</span><span class="params">(JobExecutionContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//监听job执行之前</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jobExecutionVetoed</span><span class="params">(JobExecutionContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//监听job的trigger被触发，但是job被JobListener禁止执行事件</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jobWasExecuted</span><span class="params">(JobExecutionContext context, JobExecutionException jobException)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//监听job执行完成后</span></span><br><span class="line">        log.info(<span class="string">"监听器收到job执行结果:&#123;&#125;"</span>, context.getResult());<span class="comment">//打印job执行结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="向schedule添加自定义MyJob"><a href="#向schedule添加自定义MyJob" class="headerlink" title="向schedule添加自定义MyJob"></a>向schedule添加自定义MyJob</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QuartzListener listener;<span class="comment">//监听器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 传入任务的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startDate 执行的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJob</span><span class="params">(String parameter,Date startDate)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置一个标识符</span></span><br><span class="line">        String id = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//设置传入job的参数</span></span><br><span class="line">        JobDataMap dataMap = <span class="keyword">new</span> JobDataMap();</span><br><span class="line">        dataMap.put(<span class="string">"parameter"</span>, parameter);</span><br><span class="line">        <span class="comment">//jobDetail</span></span><br><span class="line">        JobDetail jobDetail = JobBuilder.newJob(MyJob.class).withIdentity("job---"+id,id).setJobData(dataMap).build();</span><br><span class="line">        <span class="comment">//trigger</span></span><br><span class="line">        Trigger trigger = TriggerBuilder.newTrigger().withIdentity(<span class="string">"trigger---"</span>+id,id).startAt(startDate).build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">            log.info(<span class="string">"job---&#123;&#125;加入任务"</span>,id);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="controller层"><a href="#controller层" class="headerlink" title="controller层"></a>controller层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QuartzService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个任务，30s后执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 传入的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/add/&#123;parameter&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(@PathVariable(value = <span class="string">"parameter"</span>)</span> String parameter) </span>&#123;</span><br><span class="line">        <span class="comment">//设置30s后执行</span></span><br><span class="line">        Date now = <span class="keyword">new</span> Date();</span><br><span class="line">        log.info(<span class="string">"现在时间为&#123;&#125;"</span>,now);</span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.setTime(now);</span><br><span class="line">        calendar.add(Calendar.SECOND, <span class="number">30</span>);</span><br><span class="line">        <span class="comment">//执行时间</span></span><br><span class="line">        Date startDate = calendar.getTime();</span><br><span class="line">        log.info(<span class="string">"任务执行的时间为&#123;&#125;"</span>, startDate);</span><br><span class="line">        service.addJob(parameter, startDate);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"add successfully"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 得到当前任务执行的列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/job"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">job</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; res = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;Trigger&gt; triggers = <span class="keyword">null</span>;</span><br><span class="line">        String jobName = <span class="keyword">null</span>;</span><br><span class="line">        String jobGroup = <span class="keyword">null</span>;</span><br><span class="line">        Date nextFireTime = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (String groupName : scheduler.getJobGroupNames()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (JobKey jobKey : scheduler.getJobKeys(GroupMatcher.jobGroupEquals(groupName))) &#123;</span><br><span class="line">                    jobName = jobKey.getName();</span><br><span class="line">                    jobGroup = jobKey.getGroup();</span><br><span class="line">                    <span class="comment">//get trigger</span></span><br><span class="line">                    triggers = (List&lt;Trigger&gt;) scheduler.getTriggersOfJob(jobKey);</span><br><span class="line">                    nextFireTime = triggers.get(<span class="number">0</span>).getNextFireTime();</span><br><span class="line">                    res.add(<span class="string">"[jobName] : "</span> + jobName + <span class="string">" [groupName] : "</span></span><br><span class="line">                            + jobGroup + <span class="string">" - "</span> + nextFireTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="结果演示"><a href="#结果演示" class="headerlink" title="结果演示"></a>结果演示</h2><h3 id="通过接口添加一个job"><a href="#通过接口添加一个job" class="headerlink" title="通过接口添加一个job"></a>通过接口添加一个job</h3><p>参数：helloworld~~ </p>
<p><img src="https://i.loli.net/2018/05/30/5b0e0f8db01b3.png" alt=""> </p>
<p><img src="https://i.loli.net/2018/05/30/5b0e0f8dbff34.png" alt=""></p>
<h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><p>QRTZ_JOB_DETAILS表</p>
<p><img src="https://i.loli.net/2018/05/30/5b0e0f8db9358.png" alt=""></p>
<p>QRTZ_SIMPLE_TRIGGERS表</p>
<p><img src="https://i.loli.net/2018/05/30/5b0e0f8dba9c3.png" alt=""></p>
<h3 id="通过接口查看待执行的任务"><a href="#通过接口查看待执行的任务" class="headerlink" title="通过接口查看待执行的任务"></a>通过接口查看待执行的任务</h3><p><img src="https://i.loli.net/2018/05/30/5b0e0f8dc1956.png" alt=""></p>
<h3 id="一分钟后任务执行"><a href="#一分钟后任务执行" class="headerlink" title="一分钟后任务执行"></a>一分钟后任务执行</h3><p><img src="https://i.loli.net/2018/05/30/5b0e0f8dc2fff.png" alt=""></p>
<h2 id="监听器存在的一个问题"><a href="#监听器存在的一个问题" class="headerlink" title="监听器存在的一个问题"></a>监听器存在的一个问题</h2><p>如果不在schedule初始化时将监听器添加进去，那么会出现应用程序重启后会无法监听之前job的情况。</p>
<h1 id="自定义解决方案"><a href="#自定义解决方案" class="headerlink" title="自定义解决方案"></a>自定义解决方案</h1><p>上流程图</p>
<p><img src="https://i.loli.net/2018/05/31/5b0fb1ca774b7.png" alt=""></p>
<h2 id="我的自定义的quartz持久化表"><a href="#我的自定义的quartz持久化表" class="headerlink" title="我的自定义的quartz持久化表"></a>我的自定义的quartz持久化表</h2><p>仅供参考，请自行修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># author:hongkong</span><br><span class="line"># date:2018年05月31日15:57:51</span><br><span class="line"></span><br><span class="line">CREATE TABLE `PTP_MSM_TASK` (</span><br><span class="line">  `ID` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;任务id&apos;,</span><br><span class="line">  `JOB_NAME` varchar(40) DEFAULT NULL COMMENT &apos;任务名&apos;,</span><br><span class="line">  `PARAMETER` varchar(2000) DEFAULT NULL COMMENT &apos;短信参数&apos;,</span><br><span class="line">  `EXECUTE_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;执行日期&apos;,</span><br><span class="line">  `STATUS` int(11) NOT NULL COMMENT &apos;执行状态，0--未执行，1--执行成功，2--执行失败&apos;,</span><br><span class="line">  `CRON` varchar(40) DEFAULT NULL COMMENT &apos;cron表达式&apos;,</span><br><span class="line">  `TYPE` INT DEFAULT 0 NOT NULL COMMENT &apos;任务执行类型，0--立即执行，1--延时执行一次，2--利用cron表达式执行&apos;</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&apos;任务表&apos;;</span><br></pre></td></tr></table></figure>



<h2 id="pom文件-1"><a href="#pom文件-1" class="headerlink" title="pom文件"></a>pom文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.hongkong&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;demo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;name&gt;demo&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.2.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.3.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>



<h2 id="Java代码设置quartz配置-1"><a href="#Java代码设置quartz配置-1" class="headerlink" title="Java代码设置quartz配置"></a>Java代码设置quartz配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * quartz的Java配置文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QuartzListener listener;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SchedulerFactoryBean <span class="title">schedulerFactoryBean</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        SchedulerFactoryBean schedulerFactoryBean = <span class="keyword">new</span> SchedulerFactoryBean();</span><br><span class="line">        schedulerFactoryBean.setSchedulerName(<span class="string">"MsmJobSchedule"</span>);</span><br><span class="line">        <span class="comment">//quartz参数</span></span><br><span class="line">        Properties prop = <span class="keyword">new</span> Properties();</span><br><span class="line">        prop.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, <span class="string">"MsmJobSchedule"</span>);</span><br><span class="line">        prop.put(<span class="string">"org.quartz.scheduler.instanceId"</span>, <span class="string">"AUTO"</span>);</span><br><span class="line">        <span class="comment">//设置property</span></span><br><span class="line">        schedulerFactoryBean.setQuartzProperties(prop);</span><br><span class="line">        <span class="comment">//延时启动10s</span></span><br><span class="line">        schedulerFactoryBean.setStartupDelay(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> schedulerFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">scheduler</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        Scheduler scheduler = schedulerFactoryBean(dataSource).getScheduler();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//每次schedule初始化时添加监听器，否则程序重启后之前的任务无法被监听</span></span><br><span class="line">            log.info(<span class="string">"添加监听器至schedule"</span>);</span><br><span class="line">            scheduler.getListenerManager().addJobListener(listener);<span class="comment">//listener自动注入</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            log.debug(<span class="string">"监听器添加至schedule失败"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现job接口"><a href="#实现job接口" class="headerlink" title="实现job接口"></a>实现job接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Job执行的方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context job上下文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//得到传入job的参数</span></span><br><span class="line">    JobDataMap dataMap = context.getJobDetail().getJobDataMap();</span><br><span class="line">    String parameter = dataMap.getString(<span class="string">"parameter"</span>);</span><br><span class="line">    <span class="comment">//quartz自动生成的唯一id</span></span><br><span class="line">    String instanceId = context.getFireInstanceId();</span><br><span class="line">    log.info(<span class="string">"任务&#123;&#125;，参数为&#123;&#125;开始执行任务"</span>, instanceId, parameter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> time = random.nextInt(<span class="number">5000</span>) + <span class="number">1000</span>;</span><br><span class="line">        Thread.sleep(time);</span><br><span class="line">        log.info(<span class="string">"任务&#123;&#125;，参数为&#123;&#125;，时间为&#123;&#125;执行结束"</span>, instanceId, parameter, time);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现JobListener接口-1"><a href="#实现JobListener接口-1" class="headerlink" title="实现JobListener接口"></a>实现JobListener接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzListener</span> <span class="keyword">implements</span> <span class="title">JobListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PtpMsmTaskRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"QuartzListener"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jobToBeExecuted</span><span class="params">(JobExecutionContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//监听job执行之前</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jobExecutionVetoed</span><span class="params">(JobExecutionContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//监听job的trigger被触发，但是job被JobListener禁止执行事件</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jobWasExecuted</span><span class="params">(JobExecutionContext context, JobExecutionException jobException)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 得到任务的name</span></span><br><span class="line"><span class="comment">         * 根据name查找数据库</span></span><br><span class="line"><span class="comment">         * 若不存在记录，记录异常</span></span><br><span class="line"><span class="comment">         * 否则，判断传入的异常是否为空，更新对应的任务状态</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String name = context.getJobDetail().getKey().getName();</span><br><span class="line">        PtpMsmTask job = repository.findOneByName(name);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(job)) &#123;</span><br><span class="line">            log.debug(<span class="string">"数据库中无法查询到name为&#123;&#125;的任务"</span>,name);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存在记录，判断是否执行时抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(jobException)) &#123;</span><br><span class="line">            <span class="comment">//执行成功，没有异常</span></span><br><span class="line">            job.setStatus(TaskStatusEnum.SUCCESS.getType());</span><br><span class="line">            <span class="keyword">int</span> count = repository.updateByName(job,name);</span><br><span class="line">            <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">"更新job&#123;&#125;失败"</span>, job);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">"任务为&#123;&#125;，描述为&#123;&#125;的任务执行完成"</span>,name, context.getJobDetail().getDescription());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//执行时发生异常</span></span><br><span class="line">        job.setStatus(TaskStatusEnum.FAIL.getType());</span><br><span class="line">        <span class="keyword">int</span> count = repository.updateByName(job,name);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">"更新job&#123;&#125;失败"</span>, job);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"任务为&#123;&#125;，描述为&#123;&#125;的任务执行发生异常&#123;&#125;"</span>,name, context.getJobDetail().getDescription(),jobException.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="添加job"><a href="#添加job" class="headerlink" title="添加job"></a>添加job</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PtpMsmTaskRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * schedule被注入后执行的初始化函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;PtpMsmTask&gt; list = repository.findListByStatus(TaskStatusEnum.NOT_PERFORME.getType());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(list) || list.isEmpty()) &#123;</span><br><span class="line">            log.info(<span class="string">"&#123;&#125;时间点之前不存在未执行的任务"</span>,<span class="keyword">new</span> Date());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将数据库中未执行的任务重新加入至schedule中</span></span><br><span class="line">        String name = <span class="keyword">null</span>;</span><br><span class="line">        Date startDate = <span class="keyword">null</span>;</span><br><span class="line">        JobDetail jobDetail = <span class="keyword">null</span>;</span><br><span class="line">        Trigger trigger = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (PtpMsmTask job : list) &#123;</span><br><span class="line">            JobDataMap dataMap = <span class="keyword">new</span> JobDataMap();</span><br><span class="line">            dataMap.put(<span class="string">"parameter"</span>, job.getParameter());</span><br><span class="line">            name = job.getJobName();</span><br><span class="line">            startDate = job.getExecuteDate();</span><br><span class="line">            jobDetail = JobBuilder.newJob(MyJob<span class="class">.<span class="keyword">class</span>).<span class="title">withIdentity</span>(<span class="title">name</span>,<span class="title">name</span>).<span class="title">setJobData</span>(<span class="title">dataMap</span>).<span class="title">build</span>()</span>;</span><br><span class="line">            trigger = TriggerBuilder.newTrigger().withIdentity(name,name).startAt(startDate).build();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">                log.info(<span class="string">"job---&#123;&#125;加入至schedule"</span>,name);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 传入任务的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startDate 执行的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJob</span><span class="params">(String parameter,Date startDate)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置一个标识符</span></span><br><span class="line">        String id = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//设置传入job的参数</span></span><br><span class="line">        JobDataMap dataMap = <span class="keyword">new</span> JobDataMap();</span><br><span class="line">        dataMap.put(<span class="string">"parameter"</span>, parameter);</span><br><span class="line">        <span class="comment">//jobDetail</span></span><br><span class="line">        JobDetail jobDetail = JobBuilder.newJob(MyJob<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">withIdentity</span>(<span class="title">id</span>,<span class="title">id</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">setJobData</span>(<span class="title">dataMap</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">build</span>()</span>;</span><br><span class="line">        <span class="comment">//trigger</span></span><br><span class="line">        Trigger trigger = TriggerBuilder.newTrigger()</span><br><span class="line">                .withIdentity(id,id)</span><br><span class="line">                .startAt(startDate)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//写入数据库</span></span><br><span class="line">        PtpMsmTask job = PtpMsmTask.builder()</span><br><span class="line">                .jobName(id)</span><br><span class="line">                .parameter(parameter)</span><br><span class="line">                .executeDate(startDate)</span><br><span class="line">                .status(TaskStatusEnum.NOT_PERFORME.getType())</span><br><span class="line">                .type(TaskTypeEnum.LATER.getType())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">long</span> count = repository.insert(job);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"任务&#123;&#125;写入数据库失败，任务不执行"</span>, job);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">            log.info(<span class="string">"job---&#123;&#125;加入至schedule"</span>,id);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加立即执行的任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置一个标识符</span></span><br><span class="line">        String id = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//设置传入job的参数</span></span><br><span class="line">        JobDataMap dataMap = <span class="keyword">new</span> JobDataMap();</span><br><span class="line">        dataMap.put(<span class="string">"parameter"</span>, parameter);</span><br><span class="line">        <span class="comment">//jobDetail</span></span><br><span class="line">        JobDetail jobDetail = JobBuilder.newJob(MyJob<span class="class">.<span class="keyword">class</span>).<span class="title">withIdentity</span>(<span class="title">id</span>,<span class="title">id</span>).<span class="title">setJobData</span>(<span class="title">dataMap</span>).<span class="title">build</span>()</span>;</span><br><span class="line">        <span class="comment">//trigger</span></span><br><span class="line">        Trigger trigger = TriggerBuilder.newTrigger().withIdentity(id,id).startNow().build();</span><br><span class="line">        <span class="comment">//写入数据库</span></span><br><span class="line">        PtpMsmTask job = PtpMsmTask.builder()</span><br><span class="line">                .jobName(id)</span><br><span class="line">                .parameter(parameter)</span><br><span class="line">                .executeDate(<span class="keyword">new</span> Date())</span><br><span class="line">                .status(TaskStatusEnum.NOT_PERFORME.getType())</span><br><span class="line">                .type(TaskTypeEnum.NOW.getType())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">long</span> count = repository.insert(job);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"任务&#123;&#125;写入数据库失败，任务不执行"</span>, job);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">            log.info(<span class="string">"job---&#123;&#125;加入至schedule"</span>,id);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="controller层-1"><a href="#controller层-1" class="headerlink" title="controller层"></a>controller层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QuartzService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个任务，60s后执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 传入的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/add/&#123;parameter&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(@PathVariable(value = <span class="string">"parameter"</span>)</span> String parameter) </span>&#123;</span><br><span class="line">        <span class="comment">//设置60s后执行</span></span><br><span class="line">        Date now = <span class="keyword">new</span> Date();</span><br><span class="line">        log.info(<span class="string">"现在时间为&#123;&#125;"</span>,now);</span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.setTime(now);</span><br><span class="line">        calendar.add(Calendar.SECOND, <span class="number">60</span>);</span><br><span class="line">        <span class="comment">//执行时间</span></span><br><span class="line">        Date startDate = calendar.getTime();</span><br><span class="line">        log.info(<span class="string">"任务执行的时间为&#123;&#125;"</span>, startDate);</span><br><span class="line">        service.addJob(parameter, startDate);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"add successfully"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 得到当前任务执行的列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/job"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">job</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; res = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (String groupName : scheduler.getJobGroupNames()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (JobKey jobKey : scheduler.getJobKeys(GroupMatcher.jobGroupEquals(groupName))) &#123;</span><br><span class="line">                    String jobName = jobKey.getName();</span><br><span class="line">                    String jobGroup = jobKey.getGroup();</span><br><span class="line">                    <span class="comment">//get trigger</span></span><br><span class="line">                    List&lt;Trigger&gt; triggers = (List&lt;Trigger&gt;) scheduler.getTriggersOfJob(jobKey);</span><br><span class="line">                    Date nextFireTime = triggers.get(<span class="number">0</span>).getNextFireTime();</span><br><span class="line">                    res.add(<span class="string">"[jobName] : "</span> + jobName + <span class="string">",[groupName] : "</span></span><br><span class="line">                            + jobGroup + <span class="string">" - "</span> + nextFireTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加自定义数量的job</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count job的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"test/&#123;count&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(@PathVariable(value = <span class="string">"count"</span>)</span> <span class="keyword">int</span> count) </span>&#123;</span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            calendar.setTime(<span class="keyword">new</span> Date());</span><br><span class="line">            calendar.add(Calendar.SECOND, <span class="number">10</span>);</span><br><span class="line">            service.addJob(Integer.toString(i),calendar.getTime());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="两种方案比较"><a href="#两种方案比较" class="headerlink" title="两种方案比较"></a>两种方案比较</h1><h2 id="quartz原生持久化"><a href="#quartz原生持久化" class="headerlink" title="quartz原生持久化"></a>quartz原生持久化</h2><ol>
<li><p>优点</p>
<ul>
<li>支持集群</li>
<li>原生支持，不需要写SQL</li>
<li>任务恢复更有保证</li>
</ul>
</li>
<li><p>缺点</p>
<ul>
<li><p>需要是一张表，且表与表之间存在外键关联</p>
</li>
<li><p>运行速度的快慢取决于连接数据库的快慢</p>
</li>
<li><p>历史记录需要自己重新建表记录</p>
</li>
<li><p>如果数据库中存在大量过去未执行的任务（假设有5w条），当程序重启时会马上执行过期的任务，此时会出现一个我暂时无法解决的异常:( ，异常参考<a href="https://dzone.com/articles/quartz-scheduler-misfire" target="_blank" rel="noopener">链接</a> </p>
</li>
<li><pre><code>Handling the first 20 triggers that missed their scheduled fire-time.  More misfired triggers remain to be processed.
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 自定义持久化</span><br><span class="line"></span><br><span class="line">1. 优点</span><br><span class="line"></span><br><span class="line">   - 可控性较高、较为简单</span><br><span class="line">   - 数据库只需要增加一张表</span><br><span class="line"></span><br><span class="line">   ```mysql</span><br><span class="line">   CREATE TABLE `PTP_MSM_TASK` (</span><br><span class="line">     `ID` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;任务id&apos;,</span><br><span class="line">     `JOB_NAME` varchar(40) DEFAULT NULL COMMENT &apos;任务名&apos;,</span><br><span class="line">     `PARAMETER` varchar(2000) DEFAULT NULL COMMENT &apos;传入参数&apos;,</span><br><span class="line">     `EXECUTE_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;执行日期&apos;,</span><br><span class="line">     `STATUS` int(11) NOT NULL COMMENT &apos;执行状态，0--未执行，1--执行成功，2--执行失败&apos;,</span><br><span class="line">     `CRON` varchar(40) DEFAULT NULL COMMENT &apos;cron表达式&apos;,</span><br><span class="line">     `TYPE` INT DEFAULT 0 NOT NULL COMMENT &apos;任务执行类型，0--立即执行，1--延时执行一次，2--利用cron表达式执行&apos;</span><br><span class="line">     PRIMARY KEY (`ID`)</span><br><span class="line">   ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&apos;任务表&apos;;</span><br></pre></td></tr></table></figure>


</code></pre></li>
</ul>
</li>
</ol>
<ol start="2">
<li><p>缺点</p>
<ul>
<li>不支持集群（可以自己添加支持）</li>
<li>运行速度的快慢取决于连接数据库的快慢</li>
<li>因为只有一张表，记录的信息较少，如果系统挂了可能有些任务无法恢复</li>
</ul>
</li>
</ol>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://www.quartz-scheduler.org/documentation/quartz-2.x/tutorials/tutorial-lesson-09.html" target="_blank" rel="noopener">http://www.quartz-scheduler.org/documentation/quartz-2.x/tutorials/tutorial-lesson-09.html</a></p>
<p><a href="https://juejin.im/post/5abb7af36fb9a028cb2dae9a" target="_blank" rel="noopener">https://juejin.im/post/5abb7af36fb9a028cb2dae9a</a></p>
<blockquote>
<p>大部分正义感都是虚伪的 聊胜于无   —————————————————————————沃德彭尤·胡某</p>
</blockquote>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#三种任务存储模式"><span class="toc-number">1.</span> <span class="toc-text">三种任务存储模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RAMJobStore"><span class="toc-number">1.1.</span> <span class="toc-text">RAMJobStore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JDBCJobStore"><span class="toc-number">1.2.</span> <span class="toc-text">JDBCJobStore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TerracottaJobStore"><span class="toc-number">1.3.</span> <span class="toc-text">TerracottaJobStore</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#原生持久化解决方案"><span class="toc-number">2.</span> <span class="toc-text">原生持久化解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#quartz持久化需要的表SQL"><span class="toc-number">2.1.</span> <span class="toc-text">quartz持久化需要的表SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pom文件"><span class="toc-number">2.2.</span> <span class="toc-text">pom文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java代码设置quartz配置"><span class="toc-number">2.3.</span> <span class="toc-text">Java代码设置quartz配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现Job接口"><span class="toc-number">2.4.</span> <span class="toc-text">实现Job接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现JobListener接口"><span class="toc-number">2.5.</span> <span class="toc-text">实现JobListener接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#向schedule添加自定义MyJob"><span class="toc-number">2.6.</span> <span class="toc-text">向schedule添加自定义MyJob</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller层"><span class="toc-number">2.7.</span> <span class="toc-text">controller层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结果演示"><span class="toc-number">2.8.</span> <span class="toc-text">结果演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过接口添加一个job"><span class="toc-number">2.8.1.</span> <span class="toc-text">通过接口添加一个job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看数据库"><span class="toc-number">2.8.2.</span> <span class="toc-text">查看数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过接口查看待执行的任务"><span class="toc-number">2.8.3.</span> <span class="toc-text">通过接口查看待执行的任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一分钟后任务执行"><span class="toc-number">2.8.4.</span> <span class="toc-text">一分钟后任务执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#监听器存在的一个问题"><span class="toc-number">2.9.</span> <span class="toc-text">监听器存在的一个问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#自定义解决方案"><span class="toc-number">3.</span> <span class="toc-text">自定义解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#我的自定义的quartz持久化表"><span class="toc-number">3.1.</span> <span class="toc-text">我的自定义的quartz持久化表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pom文件-1"><span class="toc-number">3.2.</span> <span class="toc-text">pom文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java代码设置quartz配置-1"><span class="toc-number">3.3.</span> <span class="toc-text">Java代码设置quartz配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现job接口"><span class="toc-number">3.4.</span> <span class="toc-text">实现job接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现JobListener接口-1"><span class="toc-number">3.5.</span> <span class="toc-text">实现JobListener接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加job"><span class="toc-number">3.6.</span> <span class="toc-text">添加job</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller层-1"><span class="toc-number">3.7.</span> <span class="toc-text">controller层</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#两种方案比较"><span class="toc-number">4.</span> <span class="toc-text">两种方案比较</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#quartz原生持久化"><span class="toc-number">4.1.</span> <span class="toc-text">quartz原生持久化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&text=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&is_video=false&description=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Quartz实现持久化&body=Check out this article: https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&title=Quartz实现持久化" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://cnhkblog.top/2018/05/29/Quartz%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/&name=Quartz实现持久化&description=&lt;p&gt;最近项目中出现需求为：给定参数和时间，定时发送短信。同时希望如果服务器挂了能够重新运行这个定时任务。&lt;/p&gt;
&lt;p&gt;准备使用quartz做。&lt;/p&gt;
&lt;p&gt;所有代码在&lt;a href=&#34;https://github.com/qianhangkang/justdoit/tree/master/quartz&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;GitHub&lt;/a&gt;上，帮助到你就点个赞呗~&lt;/p&gt;
&lt;p&gt;quartz的任务存储（Job Stores）模式有三种：RAMJobStore、JDBCJobStore、TerracottaJobStore&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 qianhangkang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'qianhangkang';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
